<!DOCTYPE html>
<html lang="en">

	<head>
		<title>View Videos</title>
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
		
		<script>
		 //TBD prefetch: http://blog.pearce.org.nz/2014/02/how-to-prefetch-videoaudio-files-for.html
		 var all = {};
		 var blacklist = {}
		 
		 var playing = false;
		 var replay_videos = true;
		 
		 
		 function next_video()
		 {
		 	console.log("NEXT VIDEO CALLED");
		 	//take one from queue.. blag blag
		 	// var video = queue.shift();
		 	var video = get_next();
		 	console.log("NEXT VID IS "+video);
		 	if(video == false)
		 	{
		 		$("#container").html('');
		 		return;
		 	}
		 	video.seen += 1;
		 	playing = true;
		 	if(replay_videos == false)
		 	{
		 		blacklist[video.file] = 1;//blacklist and do not play me again...
		 	}
		 	//add loop back?
		 	$("#vid").unbind();
		 	$("#container").html('<video autoplay id="vid"> <source src="'+video.file+'" type="video\/webm"> <\/video>');
		 	changeStyle();
		 	$("#vid").bind("ended", function() {
		 	   playing = false;
			   next_video();
			});
		 	
		 }
		 
		 
		 
		 
		 function get_sorted()
		 {
		 	var maybe_keys = Object.keys(all);
		 	
		 	var keys = [];
		 	for(var i=0; i<maybe_keys.length; i+=1)
		 	{
		 		var k = maybe_keys[i];
		 		if(k in blacklist)
		 		{
		 			continue;
		 		}
		 		keys.push(k);
		 	}
		 	
		 	
		 	
			var comper = function (a, b) {
		    if (all[a].seen < all[b].seen)
		    {
		        return -1;
		    }
		    else if (all[a].seen > all[b].seen)
		    {
		        return 1;
		    }
		    else
		    {
		        if (all[b].timestamp < all[a].timestamp)
		        {
		            return -1;
		        }
		        else if (all[b].timestamp > all[a].timestamp)
		        {
		            return 1;
		        }
		        return 0;
		    }
			};
		 	//keys.sort(function(a, b){return  parseFloat(all[b].timestamp)  - all[a].timestamp || parseFloat(all[a].seen) - parseFloat(all[b].seen)});
		 	console.log(keys);
		 	keys.sort(comper);
		 	
		 	return keys;
		 }
		 
		 function get_next()
		 {
		 	//how to LRU?
		 	//Grr...
		 	// go through each thing in queue...
		 	
		 	//(1), sort twice: (1) most recent (2) number of plays.
		 	//constuct new thing based on dict keys..
		 	// var keys = Object.keys(all);
		 	// keys.sort(function(a, b){return all[a].timestamp-all[b].timestamp});
		 	// keys.reverse();
		 	// keys.sort(function(a, b){return all[a].seen-all[b].seen});
// 		 	
		 	// return all[get_sorted()[0]];
		 	var keys = get_sorted();
		 	if(keys.length == 0)
		 		return false;
		 	return all[keys[0]];

		 }
		 
		 
		 
		 
		 
		 // function black_list_any
		 function blacklist_all()
		 {
		 	//TBD
		 	var keys = Object.keys(all);
		 	for(var i=0; i<keys.length; i+=1)
		 	{
		 		blacklist[keys[i]] = 1;
		 	}
		 }
		 
		 function blacklist_most()
		 {
		 	
		 }
		 
		 
		 function get_next_old()
		 {
		 	//how to LRU?
		 	//Grr...
		 	// go through each thing in queue...
		 	
		 	//(1), sort twice: (1) most recent (2) number of plays.
		 	//constuct new thing based on dict keys..
		 	var keys = Object.keys(all);
		 	keys.sort(function(a, b){return all[a].timestamp-all[b].timestamp});
		 	keys.reverse();
		 	keys.sort(function(a, b){return all[a].seen-all[b].seen});
		 	return all[keys[0]];
		 }
		 
		 var latest = 0;
		 
		  function poll()
		  {
		  	console.log("poll");
		  	//TBD do not update old stuff
		  	$.get( "poll.php", function( data ) {
  			   var files = data['files'];
  			   for(var i=0; i<files.length; i+=1)
  			   {
  			   	var f = files[i];
  			   	
  			   	if(f.timestamp > latest)
  			   		latest = f.timestamp;
  			   		
  			   	
  			   	f['seen'] = 0;
  			   	if( f.file in all == false)
  			   	{
  			   	  all[f.file] = f;
  			   	}
  			   }
  			   // console.log(data); 
  			   // next_video();
  			   
  			   if(playing == false)
  			   {
  			   	console.log("TOOK A POLL. NEEDED NEW VID.");
  			   		next_video(); //start first video
  			   }
			});
		  	setTimeout("poll()", 1500);//not sure hw often to poll...
		  }
		  
		  var talloffset = 0; //for zooming in...
		  
		  function changeStyle()
		  {
		  	$("#vid").css("top",(-talloffset/2)+"%");
		  	$("#vid").css("height",(100+talloffset)+"%");
		  }
		
		  $(document).ready(function() {
				console.log("k. get it started, plz");
				poll();
				
				
				
				$(document).keydown(function(e) {
					console.log("KEY "+e.which)
				    switch(e.which) {
				        case 37: // left
				        break;
				
				        case 38: // up
				        talloffset += 1;
				        changeStyle();
				        break;
				
				        case 39: // right
				        break;
				
				        case 40: // down
				        talloffset -= 1;
				        changeStyle();
				        break;
				        
				        case 78: // 'n'
				        next_video();
				        break;
				        
				        //l for live only
				        case 76: // 'l'
				        console.log("BLACKLISTING");
				        playing = false;
				        replay_videos = false;
				        blacklist_all();
				        next_video();
				        break;
				        
						//r for replay mode
				        case 82: // 'r'
				        playing = false;
				        blacklist = {};
				        replay_videos = true;
				        next_video();
				        break;
				        
				
				        default: return; // exit this handler for other keys
				    }
				    e.preventDefault(); // prevent the default action (scroll / move caret)
				});
			});
		</script>
		
		<style>
		html
		{
			background-color: black;
		}
		body{
			padding: 0px;
			margin: 0px;
			background-color: black;
			width: 100%;
			height: 100%;
		}
		#container {
/*			width: 320px;*/
/*			height: 240px;*/
			position: relative;
    height: 100%;
    width: 100%;
			background-color: black;
			padding: 0px;
			margin: 0px;
			}
		#vid {
			position: fixed;
/*	position: relative;*/

			left: 50%;
			transform: 			translateX(-50%);
/*			min-width: 100%; */
			min-height: 100%;
			overflow: hidden;
			background-color: black;

		}
		</style>
	</head>
	
	
	
	
	<body>
		<div id=container>
<!-- 			webm goes here -->
		</div>
	</body>
</html>